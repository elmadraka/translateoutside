<!DOCTYPE html>
<html data-bs-theme="dark">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>TranslateOutside</title>
  <script type="text/javascript">


    /**
     * Download contents as a file
     * Source: https://stackoverflow.com/questions/14964035/how-to-export-javascript-array-info-to-csv-on-client-side
     */
    function downloadBlob(content, filename, contentType) {
      // Create a link to download it
      var dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(content, null, 2));
      var dlAnchorElem = document.createElement('a');
      dlAnchorElem.setAttribute("href", dataStr);
      dlAnchorElem.setAttribute("download", filename);
      dlAnchorElem.click();
    }

    let jsonFile, fileHeader, FileName, exportFile;
    const keysForFile = { 
      "Items.json": { 
        'keys': ['id', 'description', 'name'] 
      },
      "MAPS": { 
        'lookup': {
          'id': ['events'],
          'parameters': ['events', 'pages', 'list@code=401']
        }, 
        'keys': ['event_id', 'page_index', 'list_index', 'text'] 
      },
      "Enemies.json": ['id', 'name'] 
    }

    function reset(){
      document.getElementById('controls').innerHTML = '';
      document.getElementById('output').innerHTML = '';
      fileHeader = null;
    }

    function fileSelected(event) {
      var reader = new FileReader();
      reset();
      reader.onload = onReaderLoad;
      reader.fileName, fileName = document.getElementById('json-file-input').files[0].name;
      file_key = fileName.match(/Map[0-9]{3}.json/) !== null ? 'MAPS' : fileName
      fileHeader = keysForFile[file_key]['keys']
      reader.readAsText(document.getElementById('json-file-input').files[0]);
      document.querySelectorAll('.file-name').forEach(elem => elem.innerHTML = fileName);
      activateMergeButton();
    }

    function onReaderLoad(event){
      jsonFile = JSON.parse(event.target.result);
      loadCsv();
    }

    function setHeader(){
      fileHeader = [...document.querySelectorAll('#controls > input[type=checkbox]:checked')].map((elem) => elem.id)
      loadCsv();
    }

    function loadCsv(){
      const items = jsonFile
      
      if(!fileHeader){ setHeader(); }
      else{
        const header = fileHeader;
        const replacer = (key, value) => value === null ? '' : value

        rows = []
        items.events.filter((row) => row!==null).forEach((row) => {
          row.pages.forEach((page, page_index) => {
            page.list?.forEach((list, list_index) => {
              if(list.code === 401){
                text = list.parameters[0].replace(/\\/g, '\\\\');
                rows.push([row.id, page_index, list_index, text].join('\t'))
              }else if(list.code === 101 && ['Portrait_Recruits2', 'Portrait_NPCs'].includes(list.parameters[0])){
                text = list.parameters[4].replace(/\\/g, '\\\\');
                rows.push([row.id, page_index, list_index, text].join('\t'))
              }
            })
          })
        });

        const csv = [header.join('\t'), rows.join('\r\n')].join('\r\n');

        document.querySelector('#output + .row-number').innerHTML = `${rows.length} rows`
        document.getElementById('output').value = csv;
      }
    }

    function mergeFile(){
      exportFile = jsonFile;
      const translations = document.getElementById('merge-input').value

      translations.split('\n').slice(1).forEach(function(row){
        row = row.split('\t').map((col, index) => index > 2 ? col: parseInt(col));

        if (['Portrait_Recruits2', 'Portrait_NPCs'].includes(exportFile.events.find((event) => event?.id === row[0])?.pages[row[1]]?.list[row[2]]?.parameters[0])){
          exportFile.events.find((event) => event?.id === row[0]).pages[row[1]].list[row[2]].parameters[4] = row[3].replace(/\\\\/g, '\\').replace(/"/g, '');
        }else{
          exportFile.events.find((event) => event?.id === row[0]).pages[row[1]].list[row[2]].parameters = [row[3].replace(/\\\\/g, '\\').replace(/"/g, '')];
        }
      })
    }

    (()=>{
      const console_log = window.console.log;
      window.console.log = function(...args){
        console_log(...args);
        var textarea = document.getElementById('console');
        if(!textarea) return;
        args.forEach(arg => textarea.value = `${JSON.stringify(arg)}\n${textarea.value}`);
      }
    })();

    function activateMergeButton(){
      document.getElementById('merge-button').disabled = !(document.getElementById('merge-input').value.length > 0 && typeof fileName !== 'undefined');
    }

    document.addEventListener("DOMContentLoaded", function(event) {
      document.getElementById('json-file-input').addEventListener('change', fileSelected);
      document.querySelector('button.reload').addEventListener('click', fileSelected);
      document.getElementById('merge-input').addEventListener('input', activateMergeButton);
      document.getElementById('merge-button').addEventListener('click', function(){
        mergeFile();
        downloadBlob(exportFile, fileName, 'application/json;charset=utf-8;');
      });
    });
  </script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-SgOJa3DmI69IUzQ2PVdRZhwQ+dy64/BUtbMJw1MZ8t5HZApcHrRKUc4W0kG879m7" crossorigin="anonymous">
  <style type="text/css">
    hmtl{
      height: 100%;
    }
    body{
      min-height: 100vh;
    }
  </style>
</head>
<body class="d-flex flex-column p-4">
  <!-- Button trigger modal -->
  <button type="button" class="btn btn-outline-primary position-absolute" style="right: 1.5rem; top: 1rem;" data-bs-toggle="modal" data-bs-target="#staticBackdrop">
    HELP (?)
  </button>

  <!-- Modal -->
  <div class="modal fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="staticBackdropLabel">What is this?</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>Look Outside is a great game but is has no translations currently, this is a tool to help you make your own translation of the game.</p>
	  <p><a href='https://github.com/elmadraka/translateoutside'>github repo</a></p>
	
          <h5>How does this work?</h5>
          <ol>
            <li>On the left file selector add any Map***.json file </li>
            <li>File relevant data will be parsed and presented as a tab separated values file which you can copy to a google docs spreadsheet and start translating</li>
            <li>When you have your translation made copy the cells from the google sheet and paste them onto the right textarea as tab separated values (default copy-pasting method from gsheets)</li>
            <li>Click the merge translation to json file and a download will start with the NEW Map***.json file with your translated strings merged into the file</li>
            <li>Replace the <code>/data</code> folder file with this new downloaded file</li>
            <li>Enjoy!</li>
          </ol>
          
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary">Understood</button>
        </div>
      </div>
    </div>
  </div>
	<h1 class="text-center"><span class="file-name">Here be dragons</span></h1>
  <div class="container-fluid row border border-primary flex-grow-1 m-0 px-2 py-4">
    <div class="col-6 d-flex flex-column">
      <h2>JSON file to csv for translating</h2>
      <div class="btn-group">
        <input id="json-file-input" class="form-control" type="file" name="">
        <button class="reload btn btn-outline-secondary" type="button">
          <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e3e3e3"><path d="M480-160q-134 0-227-93t-93-227q0-134 93-227t227-93q69 0 132 28.5T720-690v-110h80v280H520v-80h168q-32-56-87.5-88T480-720q-100 0-170 70t-70 170q0 100 70 170t170 70q77 0 139-44t87-116h84q-28 106-114 173t-196 67Z"/></svg>
        </button>
      </div>
      <div id="controls" class="my-2"></div>
      <textarea id="output" class="form-control flex-grow-1"></textarea>
      <div class="border py-1 px-2 text-end row-number">&nbsp;</div>
    </div>
    <div class="col-6 d-flex flex-column border-start">
      <h2>Merge translation csv with json file</h2>
      <textarea id="merge-input" class="form-control flex-grow-1"></textarea>
      <div class="position-relative"><span class="badge position-absolute" style="right: 0;">console</span><textarea id="console" class="form-control" rows=3 readonly></textarea></div>
      <div class="d-grid gap-2">
        <button id="merge-button" class="btn btn-primary" type="button" disabled>MERGE TRANSLATION TO <span class="file-name">JSON</span> FILE</button>
      </div>
    </div>
  </div>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/js/bootstrap.bundle.min.js" integrity="sha384-k6d4wzSIapyDyv1kpU366/PK5hCdSbCRGRCMv+eplOQJWyd1fbcAu9OCUj5zNLiq" crossorigin="anonymous"></script>
</body>
</html>
